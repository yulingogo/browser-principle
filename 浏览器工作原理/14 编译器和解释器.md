### V8是如何执行一段JavaScript代码的

#### 1. 生成抽象语法树（`AST`）和执行上下文

将源代码转换为抽象语法树，并生成执行上下文。

对于编译器和解释器来说，他们理解的是抽象语法树。

`AST`是如何生成的？

+ 分词，又称词法分析。将一行行的源码拆解成一个个的`token`。`token`是指语法上不可能再分的，最小的单个字符或字符串。

  ![img](https://static001.geekbang.org/resource/image/83/f5/838028071f63a132cc8b27b23960e5f5.png)

+ 解析，又称语法分析。将上一步生成的`token`数据，根据语法规则转换为`AST`。如何源码符合语法规则，这一步顺利完成，如果源码存在语法错误，这一步会终止，并抛出语法错误。

有了`AST`后，那么`V8`就会生成该段代码的执行上下文。

#### 2. 生成字节码

有了`AST`和执行上下文之后，解释器会根据`AST`生成字节码，并解释执行字节码。

在一开始`V8`并没有字节码，而是直接将AST转换成机器码，执行机器码的效率是最高的。但是`V8`需要消耗大量的内存来存放转换后的机器码。

字节码是介于`AST`和机器码之间的一种代码，字节码需要解释器将其转换成机器码才能执行。

字节码占用内存较小。可以减少系统的内存使用。

#### 3. 执行代码

通常，有一段第一次执行的字节码，那么解释器会逐条解释执行。在执行过程中，如果发现有热点代码，后台的编译器会把热点代码编译成高效的机器码。当再次执行这段热点代码，只需只需编译后的机器码即可，从而提升效率。

热点代码，比如一段代码被重复执行多次。

解释器`Ignition`是点火器的意思，编译器`TurboFan`是涡轮增压的意思。寓意代码启动通过点火器慢慢发动，启动后，涡轮增压介入，执行效率随着执行时间越来越高效，因为热点代码都被编译成高效的机器码。

即时编译（`JIT`）: 字节码配合编译器和解释器的一种技术。

具体到V8,指解释器在解释执行字节码过程中，收集代码信息，当他发现一部分代码变热后，编译器登场，把热点代码编译成机器码，保存起来，以备下次使用。

![img](https://static001.geekbang.org/resource/image/66/8a/662413313149f66fe0880113cb6ab98a.png)